<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Library Cloud</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    
    <style>
        /* Konfigurasi CSS Variables untuk sistem Light/Dark Mode yang efisien */
        :root { --bg-color: #fcfaf2; --card-bg: white; --text-color: #1f2937; }
        body.dark-mode { --bg-color: #0d0d0d; --card-bg: #1a1a1a; --text-color: #f3f4f6; }
        body { background-color: var(--bg-color); color: var(--text-color); transition: all 0.3s ease; }
        
        /* Logic Khusus: Memastikan teks 'ADMIN' tetap hitam kontras pada Light Mode */
        .admin-black { color: #000000 !important; }
        body.dark-mode .admin-black { color: inherit !important; }

        /* Gaya Visual Luxury: Gold Gradient dan efek Glassmorphism */
        .gold-gradient { background: linear-gradient(135deg, #d4af37, #f1d382, #b8860b); }
        .card-3d { background: var(--card-bg); border: 1px solid rgba(212, 175, 55, 0.2); box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        /* Interaksi Tactile: Memberikan feedback visual 'tekan' pada tombol */
        .btn-3d { position: relative; transition: all 0.1s ease; box-shadow: 0 4px 0 #996515; border: none; top: 0; }
        .btn-3d:active { top: 3px; box-shadow: 0 1px 0 #996515; }
        
        .theme-fixed { position: fixed; top: 1.5rem; left: 1.5rem; z-index: 50; }
        input { background: var(--bg-color) !important; color: var(--text-color) !important; border: 1px solid rgba(212, 175, 55, 0.3) !important; }
        table thead tr { background: rgba(212, 175, 55, 0.1); }
        .toast-active { transform: translateY(0); opacity: 1; }
    </style>
</head>
<body class="min-h-screen p-4">
    <div id="toast-container" class="fixed bottom-5 right-5 z-[200] flex flex-col gap-2"></div>

    <div id="confirm-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-md flex items-center justify-center p-4 z-[210]">
        <div class="card-3d p-8 rounded-[2.5rem] w-full max-w-sm border-t-8 border-amber-500 text-center">
            <div id="confirm-icon" class="text-4xl mb-4">‚ö†Ô∏è</div>
            <h3 id="confirm-msg" class="text-lg font-bold mb-6 italic uppercase tracking-tighter">Apakah Anda yakin?</h3>
            <div class="flex gap-3">
                <button id="confirm-ok" class="flex-1 gold-gradient text-white py-3 rounded-xl font-black btn-3d uppercase text-xs">Ya, Lanjutkan</button>
                <button onclick="closeConfirm()" class="flex-1 bg-gray-500/10 text-gray-500 py-3 rounded-xl font-bold text-xs uppercase border border-gray-300">Batal</button>
            </div>
        </div>
    </div>

    <div id="app" class="max-w-7xl mx-auto p-4">
        <div class="theme-fixed">
            <button onclick="toggleDarkMode()" class="p-3 rounded-full card-3d text-xl shadow-lg border-2 border-amber-500/30" id="theme-toggle">üåô</button>
        </div>

        <div id="auth-section" class="max-w-md mx-auto card-3d p-12 rounded-[3rem] shadow-2xl mt-10 text-center border-t-8 border-amber-500">
            <div class="w-20 h-20 gold-gradient rounded-full mx-auto mb-6 flex items-center justify-center shadow-xl">
                <span class="text-3xl text-white">üîë</span>
            </div>
            <h1 class="text-3xl font-black text-amber-700 italic mb-10 tracking-widest uppercase"><span class="admin-black">Admin</span> Portal</h1>
            <div class="space-y-6">
                <input id="user" type="text" placeholder="Username Admin" class="w-full p-4 rounded-xl text-center outline-none">
                <input id="pass" type="password" placeholder="Password" class="w-full p-4 rounded-xl text-center outline-none">
                <button onclick="handleLogin()" class="w-full gold-gradient text-white font-black py-4 rounded-xl btn-3d uppercase tracking-widest">MASUK <span class="admin-black">ADMIN</span></button>
            </div>
        </div>

        <div id="dashboard" class="hidden">
            <div class="flex flex-col lg:flex-row justify-between items-center mb-10 card-3d p-8 rounded-[2rem] gap-6 border-b-4 border-amber-500">
                <div>
                    <p class="text-xs text-amber-600 font-black tracking-widest uppercase mb-1"><span class="admin-black">Admin</span>istrator</p>
                    <h2 id="welcome" class="text-4xl font-black italic uppercase tracking-tighter text-gray-800 dark:text-gray-100"></h2>
                </div>
                <div class="flex gap-3">
                    <button onclick="switchTab('inventory')" id="tab-inv" class="px-10 py-3 rounded-xl font-black transition-all bg-amber-600 text-white shadow-md">INVENTARIS</button>
                    <button onclick="switchTab('monitoring')" id="tab-mon" class="px-10 py-3 rounded-xl font-black border-2 border-amber-500/30 opacity-60">MONITORING</button>
                    <button onclick="confirmLogout()" class="px-10 py-3 bg-red-600 text-white rounded-xl font-black btn-3d" style="box-shadow: 0 4px 0 #7f1d1d;">KELUAR</button>
                </div>
            </div>

            <div id="section-inventory">
                <div class="card-3d p-10 rounded-[3rem] mb-10 border-b-4 border-amber-500">
                    <h3 id="form-title" class="font-black text-2xl text-amber-600 uppercase mb-8 flex items-center gap-3 italic tracking-tighter">
                        <span class="gold-gradient text-white w-10 h-10 flex items-center justify-center rounded-lg not-italic">‚úö</span> Tambah Koleksi Buku Baru
                    </h3>
                    <input type="hidden" id="book-id">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="space-y-1"><label class="text-[10px] font-black opacity-60 uppercase ml-1">Judul Buku</label><input id="title" class="w-full p-3 rounded-xl outline-none"></div>
                        <div class="space-y-1"><label class="text-[10px] font-black opacity-60 uppercase ml-1">Penulis</label><input id="author" class="w-full p-3 rounded-xl outline-none"></div>
                        <div class="space-y-1"><label class="text-[10px] font-black opacity-60 uppercase ml-1">Tahun Terbit</label><input id="year" type="number" class="w-full p-3 rounded-xl outline-none"></div>
                        <div class="space-y-1"><label class="text-[10px] font-black opacity-60 uppercase ml-1">Genre</label><input id="genre" class="w-full p-3 rounded-xl outline-none"></div>
                        <div class="space-y-1"><label class="text-[10px] font-black opacity-60 uppercase ml-1">URL Gambar Sampul</label><input id="cover_url" class="w-full p-3 rounded-xl outline-none"></div>
                        <div class="space-y-1"><label class="text-[10px] font-black opacity-60 uppercase ml-1">Jumlah Stok</label><input id="stock" type="number" class="w-full p-3 rounded-xl outline-none"></div>
                    </div>
                    <div class="flex gap-4 mt-8 pb-4">
                        <button onclick="addBook()" id="btn-save" class="flex-1 gold-gradient text-white py-4 rounded-xl font-black btn-3d uppercase tracking-widest">SIMPAN KE DATABASE</button>
                        <button onclick="resetForm()" id="btn-cancel" class="hidden px-10 bg-gray-500 text-white rounded-xl font-bold uppercase text-xs">Batal</button>
                    </div>
                </div>
                <div id="book-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </div>

            <div id="section-monitoring" class="hidden card-3d rounded-[2rem] overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead><tr class="border-b-2 border-amber-500/20"><th class="p-6 text-amber-600 font-black uppercase text-xs">Buku</th><th class="p-6 text-amber-600 font-black uppercase text-xs">Peminjam</th><th class="p-6 text-amber-600 font-black uppercase text-xs">Pinjam</th><th class="p-6 text-amber-600 font-black uppercase text-xs">Kembali</th><th class="p-6 text-amber-600 font-black uppercase text-xs text-center">Status</th></tr></thead>
                        <tbody id="monitoring-list" class="divide-y divide-amber-500/10"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * FUNGSI UTILITIES (UI & State)
         */

        function showNotify(msg, type = 'error') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `px-6 py-3 rounded-xl shadow-2xl border-l-8 font-bold transition-all duration-300 transform translate-y-10 opacity-0 ${type === 'error' ? 'bg-red-50 text-red-700 border-red-500' : 'bg-green-50 text-green-700 border-green-500'}`;
            toast.innerText = msg;
            container.appendChild(toast);
            setTimeout(() => { toast.classList.add('toast-active', 'translate-y-0'); toast.classList.remove('opacity-0'); }, 10);
            setTimeout(() => { toast.classList.remove('toast-active', 'translate-y-0'); toast.classList.add('opacity-0'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        let confirmAction = null;
        function showCustomConfirm(msg, action, icon = '‚ö†Ô∏è') {
            document.getElementById('confirm-msg').innerText = msg;
            document.getElementById('confirm-icon').innerText = icon;
            document.getElementById('confirm-modal').classList.remove('hidden');
            confirmAction = action;
        }
        function closeConfirm() { document.getElementById('confirm-modal').classList.add('hidden'); confirmAction = null; }
        document.getElementById('confirm-ok').onclick = () => { if(confirmAction) confirmAction(); closeConfirm(); };

        function toggleDarkMode() {
            const body = document.body; const btn = document.getElementById('theme-toggle');
            body.classList.toggle('dark-mode');
            const isDark = body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            btn.innerText = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        /**
         * AUTENTIKASI & INITIALIZATION
         */

        window.onload = () => { 
            if(localStorage.getItem('theme') === 'dark') toggleDarkMode();
            const token = localStorage.getItem('admin_token');
            if (token) showDashboard(localStorage.getItem('admin_role'));
        };

        async function handleLogin() {
            const u = document.getElementById('user').value;
            const p = document.getElementById('pass').value;
            if(!u || !p) return showNotify("Username dan Password tidak boleh kosong!");
            
            const { status, data } = await callAPI(`${AUTH_URL}/admin/login`, 'POST', { username: u, password: p }, 'admin');
            if (data && data.token) { 
                localStorage.setItem('admin_token', data.token); 
                localStorage.setItem('admin_role', data.role); 
                location.reload(); 
            } else { 
                showNotify("Login Gagal! Akun tidak ditemukan."); 
            }
        }

        function confirmLogout() { 
            showCustomConfirm("Apakah Anda yakin ingin keluar?", () => {
                localStorage.removeItem('admin_token');
                localStorage.removeItem('admin_role');
                location.reload();
            }, 'üö™'); 
        }

        /**
         * CORE DASHBOARD LOGIC
         */

        function showDashboard(role) { 
            document.getElementById('auth-section').classList.add('hidden'); 
            document.getElementById('dashboard').classList.remove('hidden'); 
            document.getElementById('welcome').innerHTML = role.toUpperCase() === 'ADMIN' ? `<span class="admin-black">${role}</span>` : role; 
            refreshAdminData(); 
            setInterval(refreshAdminData, 5000); 
        }
        
        function refreshAdminData() { if(!document.getElementById('dashboard').classList.contains('hidden')) { loadBooks(); loadMonitoring(); } }
        
        function switchTab(tab) {
            const inv = document.getElementById('section-inventory'); const mon = document.getElementById('section-monitoring');
            const tInv = document.getElementById('tab-inv'); const tMon = document.getElementById('tab-mon');
            if(tab === 'inventory') { inv.classList.remove('hidden'); mon.classList.add('hidden'); tInv.className = "px-10 py-3 rounded-xl font-black bg-amber-600 text-white shadow-md"; tMon.className = "px-10 py-3 rounded-xl font-black border-2 border-amber-500/30 opacity-60"; }
            else { inv.classList.add('hidden'); mon.classList.remove('hidden'); tMon.className = "px-10 py-3 rounded-xl font-black bg-amber-600 text-white shadow-md"; tInv.className = "px-10 py-3 rounded-xl font-black border-2 border-amber-500/30 opacity-60"; loadMonitoring(); }
        }

        /**
         * CRUD & DATA FETCHING (INVENTORY)
         */

        async function loadBooks() {
            const { data } = await callAPI(`${MAIN_URL}/books`, 'GET', null, 'admin');
            const list = document.getElementById('book-list');
            if(!data) return;
            list.innerHTML = data.map(b => `<div class="card-3d p-6 rounded-3xl flex gap-6 items-center"><img src="${b.cover_url || 'https://via.placeholder.com/100x150'}" class="w-20 h-28 object-cover rounded-xl shadow-lg"><div class="flex-1 overflow-hidden text-left"><h4 class="font-black uppercase text-lg truncate tracking-tighter">${b.title}</h4><p class="text-amber-500 text-xs font-bold mb-2 tracking-widest">${b.author}</p><div class="flex gap-2"><span class="text-[9px] bg-amber-500/10 px-2 py-1 rounded-md border border-amber-500/20 uppercase font-black text-amber-600">${b.genre}</span><span class="text-[9px] opacity-60 font-bold uppercase mt-1 italic">Stok: ${b.stock}</span></div><div class="mt-4 flex gap-2 pb-4"><button onclick='editBook(${JSON.stringify(b)})' class="px-6 py-2 gold-gradient text-white text-[10px] font-black rounded-lg btn-3d tracking-widest uppercase">Edit</button><button onclick="deleteBook(${b.id})" class="px-6 py-2 bg-red-500/10 text-red-500 text-[10px] font-black rounded-lg border border-red-500/20 uppercase">Hapus</button></div></div></div>`).join('');
        }

        // POST/PUT: Menambah atau memperbarui data buku (FIXED LOGIC)
        async function addBook() {
            const id = document.getElementById('book-id').value; // Ambil ID dari hidden input
            const t = document.getElementById('title').value; 
            const a = document.getElementById('author').value; 
            const y = document.getElementById('year').value; 
            const g = document.getElementById('genre').value; 
            const c = document.getElementById('cover_url').value; 
            const s = document.getElementById('stock').value;

            if(!t || !a || !y || !g || !c || !s) return showNotify("Semua field buku wajib diisi!");
            
            const body = { title: t, author: a, year: y, genre: g, cover_url: c, stock: s };
            
            // TENTUKAN URL & METHOD: Jika ada ID maka PUT (Update), jika tidak maka POST (Tambah)
            const url = id ? `${MAIN_URL}/books/${id}` : `${MAIN_URL}/books`;
            const method = id ? 'PUT' : 'POST';

            const { status } = await callAPI(url, method, body, 'admin');
            
            if (status === 201 || status === 200) { 
                showNotify(id ? "Data buku diperbarui!" : "Buku baru ditambahkan!", "success"); 
                refreshAdminData(); 
                resetForm(); 
            } else {
                showNotify("Gagal menyimpan ke database.");
            }
        }

        function editBook(b) { 
            document.getElementById('book-id').value = b.id; 
            document.getElementById('title').value = b.title; 
            document.getElementById('author').value = b.author; 
            document.getElementById('year').value = b.year; 
            document.getElementById('genre').value = b.genre; 
            document.getElementById('cover_url').value = b.cover_url; 
            document.getElementById('stock').value = b.stock; 
            document.getElementById('form-title').innerHTML = '<span class="gold-gradient text-white w-10 h-10 flex items-center justify-center rounded-lg">‚úèÔ∏è</span> Edit Data Buku'; 
            document.getElementById('btn-save').innerText = 'UPDATE PERUBAHAN'; 
            document.getElementById('btn-cancel').classList.remove('hidden'); 
            window.scrollTo({top: 0, behavior: 'smooth'}); 
        }
        
        function resetForm() { 
            document.getElementById('book-id').value = ''; 
            document.querySelectorAll('#section-inventory input').forEach(i => i.value = ''); 
            document.getElementById('form-title').innerHTML = '<span class="gold-gradient text-white w-10 h-10 flex items-center justify-center rounded-lg">‚úö</span> Tambah Koleksi Buku Baru'; 
            document.getElementById('btn-save').innerText = 'SIMPAN KE DATABASE'; 
            document.getElementById('btn-cancel').classList.add('hidden'); 
        }
        
        async function deleteBook(id) { 
            showCustomConfirm("Hapus buku ini secara permanen?", async () => { 
                await callAPI(`${MAIN_URL}/books/${id}`, 'DELETE', null, 'admin'); 
                showNotify("Buku berhasil dihapus.", "success"); 
                refreshAdminData(); 
            }, 'üóëÔ∏è'); 
        }

        /**
         * MONITORING LOGIC
         */

        async function loadMonitoring() {
            const { data } = await callAPI(`${MAIN_URL}/borrowings/all`, 'GET', null, 'admin');
            const list = document.getElementById('monitoring-list');
            if(!data) return;
            list.innerHTML = data.map(m => `<tr class="hover:bg-amber-500/5 transition-all"><td class="p-6 text-xs font-black uppercase italic tracking-tighter">${m.title}</td><td class="p-6"><p class="text-xs font-bold text-amber-600 uppercase">${m.borrower_name || m.user_id}</p><p class="text-[9px] opacity-60 font-bold uppercase tracking-widest">${m.borrower_phone || '-'}</p></td><td class="p-6 text-[10px] opacity-60 font-black italic">${m.borrow_date.replace('T', ' ').slice(0, 16)}</td><td class="p-6 text-[10px] opacity-60 font-black italic">${m.return_date ? m.return_date.replace('T', ' ').slice(0, 16) : '-'}</td><td class="p-6 text-center"><span class="px-4 py-1 rounded-full text-[8px] font-black uppercase tracking-widest ${m.return_date ? 'bg-green-500/10 text-green-500 border border-green-500/30' : 'bg-amber-500/10 text-amber-600 border border-amber-500/30'}">${m.return_date ? 'Selesai' : 'Aktif'}</span></td></tr>`).join('');
        }
    </script>
</body>
</html>
